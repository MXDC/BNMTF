"""
Test the performance of Gibbs sampling for recovering a toy dataset, where we 
vary the fraction of entries that are missing.
We repeat this 10 times per fraction and average that.

We use the correct number of latent factors and same priors as used to generate the data.

I, J, K, L = 100, 80, 5, 5
"""

project_location = "/home/tab43/Documents/Projects/libraries/"
import sys
sys.path.append(project_location)

from BNMTF.code.bnmtf_gibbs_optimised import bnmtf_gibbs_optimised
from BNMTF.experiments.generate_toy.bnmf.generate_bnmf import try_generate_M
from ml_helpers.code.mask import calc_inverse_M

import numpy, matplotlib.pyplot as plt

##########

fractions_unknown = [ 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9 ]

input_folder = project_location+"BNMTF/experiments/generate_toy/bnmtf/"

repeats = 10 # number of times we try each fraction
iterations = 1000
burn_in = 800
thinning = 5

init_S = 'random'
init_FG = 'kmeans'
I,J,K,L = 100, 80, 5, 5

alpha, beta = 1., 1.
lambdaF = numpy.ones((I,K))/10.
lambdaS = numpy.ones((K,L))/10.   
lambdaG = numpy.ones((J,L))/10.
priors = { 'alpha':alpha, 'beta':beta, 'lambdaF':lambdaF, 'lambdaS':lambdaS, 'lambdaG':lambdaG }

metrics = ['MSE', 'R^2', 'Rp']


# Load in data
R = numpy.loadtxt(input_folder+"R.txt")


# Generate matrices M - one list of M's for each fraction
M_attempts = 100
all_Ms = [ 
    [try_generate_M(I,J,fraction,M_attempts) for r in range(0,repeats)]
    for fraction in fractions_unknown
]
all_Ms_test = [ [calc_inverse_M(M) for M in Ms] for Ms in all_Ms ]

# Make sure each M has no empty rows or columns
def check_empty_rows_columns(M,fraction):
    sums_columns = M.sum(axis=0)
    sums_rows = M.sum(axis=1)
    for i,c in enumerate(sums_rows):
        assert c != 0, "Fully unobserved row in M, row %s. Fraction %s." % (i,fraction)
    for j,c in enumerate(sums_columns):
        assert c != 0, "Fully unobserved column in M, column %s. Fraction %s." % (j,fraction)
        
for Ms,fraction in zip(all_Ms,fractions_unknown):
    for M in Ms:
        check_empty_rows_columns(M,fraction)


# We now run the Gibbs sampler on each of the M's for each fraction.
all_performances = {metric:[] for metric in metrics} 
average_performances = {metric:[] for metric in metrics} # averaged over repeats
for (fraction,Ms,Ms_test) in zip(fractions_unknown,all_Ms,all_Ms_test):
    print "Trying fraction %s." % fraction
    
    # Run the algorithm <repeats> times and store all the performances
    for metric in metrics:
        all_performances[metric].append([])
    for (repeat,M,M_test) in zip(range(0,repeats),Ms,Ms_test):
        print "Repeat %s of fraction %s." % (repeat+1, fraction)
    
        # Run the Gibbs sampler
        BNMTF = bnmtf_gibbs_optimised(R,M,K,L,priors)
        BNMTF.initialise(init_S, init_FG)
        BNMTF.run(iterations)
    
        # Measure the performances
        performances = BNMTF.predict(M_test,burn_in,thinning)
        for metric in metrics:
            # Add this metric's performance to the list of <repeat> performances for this fraction
            all_performances[metric][-1].append(performances[metric])
            
    # Compute the average across attempts
    for metric in metrics:
        average_performances[metric].append(sum(all_performances[metric][-1])/repeats)
    
 
print "repeats=%s \nfractions_unknown = %s \nall_performances = %s \naverage_performances = %s" % \
    (repeats,fractions_unknown,all_performances,average_performances)


'''
repeats=10 
fractions_unknown = [0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9] 
all_performances = {'R^2': [[0.9982483427512238, 0.9982569106019503, 0.9980274882567254, 0.9981494402541832, 0.998278814922556, 0.9980119458152925, 0.9956195798944338, 0.9978656571576676, 0.9948160505407695, 0.9954424584311419], [0.9981333905047056, 0.9979100423069163, 0.9955442299110503, 0.9978676991250482, 0.9977577278512513, 0.9976874007674094, 0.9979539285118952, 0.9945971203469434, 0.9979930384329919, 0.9952512628300171], [0.9978378347855068, 0.9978801890932645, 0.9979429165098603, 0.9977768522969408, 0.9978015658203891, 0.9979260351113085, 0.996066582239531, 0.9978949112777393, 0.9957051056029234, 0.9978325348985365], [0.997676691750717, 0.9978240400104373, 0.9976582073437797, 0.9977758430041533, 0.9978329364443173, 0.9969584609777844, 0.9977265503307726, 0.9977142397526078, 0.9976826750311384, 0.9952749146733821], [0.9976399737704836, 0.99767873779128, 0.9976443573817393, 0.9977386446047206, 0.9951828897567764, 0.9951514756864354, 0.9975228041236924, 0.9946232273494868, 0.9978052124263244, 0.9975976092972867], [0.9974415991464385, 0.9973033769326197, 0.9974228772025158, 0.9946088115543904, 0.9952143307189987, 0.9973675266253234, 0.9973057070437303, 0.9975558402516823, 0.995458400143532, 0.9960985828203994], [0.9969530909108212, 0.9968029147445387, 0.9971504420281516, 0.9969488841655992, 0.9970958121880199, 0.9966773266250664, 0.9938682775624493, 0.9961049113779932, 0.9971622118352892, 0.9962192432064729], [0.9951026931828699, 0.7660836211471911, 0.9940445719835007, 0.9896536121295896, 0.9945659040952501, 0.988406717974716, 0.9945113008065473, 0.9933068784853915, 0.9948281657813091, 0.9883895464109994], [0.9604700232586909, 0.9418352745019882, 0.9369170279940039, 0.9565231890815216, 0.9358135672871284, 0.8901515028861764, 0.8526143726709253, 0.9208252572952669, 0.9356639631955865, 0.9150298363582962]], 'MSE': [[1.0808729277323119, 1.18368144459457, 1.2482719449362341, 1.1352963780276244, 1.1601753464233808, 1.2151973041786375, 2.4164737182848612, 1.0003148188857787, 2.5942229347788701, 2.5047896536227752], [1.1843314818742263, 1.1757671232787674, 2.3327245493978142, 1.180128107517465, 1.2842800506080199, 1.2049850235424111, 1.1741921882187809, 2.6600499717779962, 1.1793531712106733, 2.3543081940898762], [1.1934944009676398, 1.1532830073107854, 1.1881850407423593, 1.2723946725367128, 1.1969609359130404, 1.1820559488750182, 2.1844437217494734, 1.2357711054636829, 2.5090964813586178, 1.2489422401685326], [1.2567834776223799, 1.2821691826936066, 1.2778268649507891, 1.2398649211877735, 1.269188460871127, 1.7206999288175755, 1.2723402639850054, 1.3159164252553697, 1.3056890035508482, 2.6459275490234186], [1.3352877670730834, 1.3091042045422829, 1.3757174781757739, 1.3218586672018222, 2.8378647331470948, 2.8539780438341107, 1.3763994810692057, 3.1346541016602063, 1.2627770325484942, 1.3552280130779939], [1.4273094743725785, 1.434595115336204, 1.4414922183831713, 3.1444806421280123, 2.7650267118008376, 1.4994353926134174, 1.5055629844820049, 1.4048879955687767, 2.5038299916651563, 2.1756197439514939], [1.7057462912279295, 1.7687744319713692, 1.6912811269774135, 1.7545816423023897, 1.6997773173924611, 1.8524989169496267, 3.7351769734582869, 2.2455798397048525, 1.6333754736408459, 2.1284626338691859], [2.8764183132345198, 133.28868633880313, 3.4275049923166159, 5.8175482017201547, 3.0216424960900752, 6.636517556428573, 3.1689426347781566, 3.8465728232748919, 2.8425068991088369, 6.7790560467166632], [22.746691909833263, 33.965778984081581, 36.678462115333879, 24.265612382882104, 36.69617505247831, 63.349738963708447, 87.175153541863423, 44.434758152770009, 36.98431698415704, 48.325280731695656]], 'Rp': [[0.99912516809597618, 0.99912851773747435, 0.99902078016367113, 0.99907517480901609, 0.99914130584730865, 0.99900909539166127, 0.99781355387802606, 0.99893498768325473, 0.99741192949954183, 0.99772840388063777], [0.99906896273817913, 0.99895546524041756, 0.99777108816072069, 0.99893367385739462, 0.99888001792878434, 0.99884364370922263, 0.99898235904188715, 0.99729948561669479, 0.99899846939967685, 0.9976235544251435], [0.99891970066134772, 0.99894025119643926, 0.9989709990498068, 0.99889600199496409, 0.99890045003686645, 0.99896950839660326, 0.99803167530417058, 0.99894693152792535, 0.99785317200816015, 0.9989163680880413], [0.99883802086280249, 0.99891205124831806, 0.99882855861506181, 0.99888819899015546, 0.99891625616289104, 0.99847935187870773, 0.9988635008728064, 0.99885666071349033, 0.99884142021146249, 0.99763650528105718], [0.99881931461007267, 0.99883907225947521, 0.99882521703774507, 0.99886957062578896, 0.99759178641050417, 0.9975759499631629, 0.99876171369078648, 0.99731636912507449, 0.99890200604899682, 0.99879909022956881], [0.99872016035090416, 0.99865174508570609, 0.99871202743283161, 0.99730266352461239, 0.99761485691080254, 0.9986837676833864, 0.99865496163849943, 0.9987830854960299, 0.99772732112716123, 0.99805260696793585], [0.99847543269100858, 0.99840238958422556, 0.9985774179542497, 0.99847394537416589, 0.99854878675140835, 0.998342381253425, 0.99693604454918139, 0.99805221003147171, 0.99858452038867496, 0.99815566028782421], [0.99754896717769803, 0.90215350634469194, 0.99703268682471291, 0.99481732988659644, 0.99728421301420844, 0.99420108823119557, 0.99726133375675019, 0.99672051769687564, 0.99746222771838566, 0.99424539714288396], [0.98013962371773777, 0.97052142905834449, 0.96830971738355365, 0.97902496448688414, 0.96872344339992877, 0.9472304589893894, 0.93174801167995647, 0.96359386301586958, 0.96929248236658549, 0.96151655640683065]]} 
average_performances = {'R^2': [0.99727166886259455, 0.99706958405882296, 0.99746645276360013, 0.99741245593190886, 0.99685849321882247, 0.99657770524396305, 0.99649831146444023, 0.96988930119973649, 0.9245844014529585], 'MSE': [1.5539296471465043, 1.573011986151603, 1.4364627555085865, 1.4586406077957892, 1.816286952233007, 1.9302240270301652, 2.0215254647494367, 17.170539630247159, 43.462196881880374], 'Rp': [0.99863889169865683, 0.99853567201181215, 0.99873450582643242, 0.99870605248367528, 0.99843000900011758, 0.99829031962178694, 0.9982548788865635, 0.98687272677939963, 0.96401005505050819]}
'''


# Plot the MSE, R^2 and Rp
for metric in metrics:
    plt.figure()
    x = fractions_unknown
    y = average_performances[metric]
    plt.plot(x,y)
    plt.xlabel("Fraction missing")
    plt.ylabel(metric)