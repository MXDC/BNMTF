"""
Recover the toy dataset generated by example/generate_toy/bnmf/generate_bnmf.py
using the non-probabilistic NMF.

We can plot the MSE, R2 and Rp as it converges, on the entire dataset.

We have I=100, J=80, K=10, and no test data.
"""

project_location = "/home/tab43/Documents/Projects/libraries/"
import sys
sys.path.append(project_location)

from BNMTF.code.nmf_np import NMF
from ml_helpers.code.mask import calc_inverse_M

import numpy, matplotlib.pyplot as plt

##########

input_folder = project_location+"BNMTF/experiments/generate_toy/bnmf/"

iterations = 10
I, J, K = 100,80,10

init_UV = 'exponential'
expo_prior = 1/10.

# Load in data
R = numpy.loadtxt(input_folder+"R.txt")
M = numpy.ones((I,J))
#M = numpy.loadtxt(input_folder+"M.txt")
M_test = calc_inverse_M(numpy.loadtxt(input_folder+"M.txt"))

# Run the VB algorithm
nmf = NMF(R,M,K) 
nmf.initialise(init_UV,expo_prior)
nmf.run(iterations)

# Also measure the performances
performances = nmf.predict(M_test)
print "Performance on test set: %s." % performances

# Extract the performances across all iterations
print "np_all_performances = %s" % nmf.all_performances

'''
np_all_performances = {'R^2': [0.29896630985443795, 0.6029746265568162, 0.631614383489399, 0.6481233757519593, 0.6607548292076648, 0.6712089938271184, 0.6803246885916399, 0.6886406576123596, 0.6965251250179424, 0.7042356713740292, 0.711951873227887, 0.719793663949166, 0.7278325335139995, 0.7360993845248691, 0.7445905054084361, 0.7532719934344667, 0.7620833284023394, 0.7709418885464703, 0.7797504166285718, 0.7884078700123761, 0.796821592451683, 0.8049173162278968, 0.8126443178211892, 0.8199753284542842, 0.8269027578908268, 0.8334333955222379, 0.8395832594184209, 0.8453734407329689, 0.8508271514293544, 0.8559678421618915, 0.8608181328011584, 0.8653992898602425, 0.869731029079896, 0.8738314838045672, 0.8777172417034211, 0.8814034029718727, 0.8849036474169373, 0.8882303155884208, 0.8913945134452721, 0.8944062456720191, 0.8972745746420527, 0.9000077942735795, 0.9026136032733546, 0.9050992615142092, 0.9074717161660284, 0.9097376894369537, 0.9119037258120603, 0.9139762021051165, 0.9159613075464235, 0.917865003161746, 0.9196929699753085, 0.9214505545087421, 0.9231427181686549, 0.9247739949123921, 0.9263484594609154, 0.9278697065992529, 0.9293408409909871, 0.9307644765633967, 0.9321427448996292, 0.9334773130366497, 0.934769412242694, 0.9360198801948816, 0.9372292189148865, 0.9383976694471131, 0.9395253015999184, 0.940612113688414, 0.9416581341379643, 0.942663515137038, 0.9436286089765301, 0.9445540202473514, 0.9454406309153015, 0.9462895992968792, 0.9471023370918287, 0.947880470352522, 0.9486257906161006, 0.9493402017971815, 0.9500256673378652, 0.9506841609275934, 0.9513176230452094, 0.9519279246978324, 0.9525168390190015, 0.9530860208093866, 0.95363699363667, 0.9541711437506065, 0.9546897198142874, 0.9551938373006434, 0.9556844863466178, 0.956162541884042, 0.9566287749617114, 0.9570838643221694, 0.9575284074836433, 0.9579629307860117, 0.9583878980726506, 0.9588037178804075, 0.959210749182451, 0.9596093058616252, 0.9599996601787649, 0.9603820455409567, 0.9607566588742087, 0.961123662872752, 0.9614831883442178, 0.9618353368068131, 0.9621801834299369, 0.9625177803492133, 0.9628481603340141, 0.9631713407416403, 0.9634873276580701, 0.9637961201009596, 0.9640977141469882, 0.964392106843248, 0.9646792997713811, 0.964959302152939, 0.9652321334131222, 0.9654978251547166, 0.9657564225307563, 0.9660079850391415, 0.9662525867913536, 0.9664903163278905, 0.9667212760638165, 0.9669455814491809, 0.9671633599226586, 0.9673747497250632, 0.9675798986252738, 0.9677789625971969, 0.9679721044746629, 0.9681594926027778, 0.9683412994994877, 0.9685177005394885, 0.9686888726732058, 0.9688549931952166, 0.9690162385781512, 0.9691727833889315, 0.9693247993037396, 0.9694724542361867, 0.9696159115899604, 0.9697553296431172, 0.9698908610666109, 0.9700226525750718, 0.9701508447036649, 0.9702755717013603, 0.9703969615282944, 0.9705151359431683, 0.9706302106657675, 0.9707422955995967, 0.9708514951001761, 0.9709579082755699, 0.9710616293070696, 0.9711627477795005, 0.9712613490122344, 0.9713575143835909, 0.9714513216428386, 0.9715428452054032, 0.9716321564281427, 0.9717193238626498, 0.971804413485475, 0.9718874889049511, 0.9719686115449433, 0.9720478408063574, 0.9721252342076416, 0.9722008475057997, 0.9722747347996412, 0.972346948617104, 0.9724175399885465, 0.9724865585078928, 0.9725540523834584, 0.9726200684802042, 0.9726846523550278, 0.9727478482865769, 0.9728096993009044, 0.9728702471941265, 0.9729295325530867, 0.9729875947748653, 0.9730444720858284, 0.9731002015607653, 0.9731548191425394, 0.9732083596625627, 0.9732608568622978, 0.973312343415911, 0.973362850954122, 0.9734124100892311, 0.9734610504412609, 0.9735088006651036, 0.9735556884785345, 0.9736017406909291, 0.9736469832325048, 0.9736914411838963, 0.9737351388058691, 0.9737780995689693, 0.9738203461829176, 0.9738619006255517, 0.9739027841711352, 0.973943017417856, 0.9739826203143535, 0.9740216121851238, 0.9740600117546686, 0.9740978371702692, 0.9741351060232877, 0.9741718353689094, 0.9742080417442687, 0.9742437411849132], 'MSE': [27.566216917689612, 15.611928099902054, 14.485748626402636, 13.836578025617813, 13.339880946946206, 12.92879974836179, 12.570350186284298, 12.243347634012737, 11.933312692984982, 11.630116717679352, 11.326698355517674, 11.018341557428528, 10.702235177218471, 10.377164055252083, 10.043274138917065, 9.7018985596004779, 9.3554171073205357, 9.007078655197347, 8.6607075759609842, 8.320277092679671, 7.9894306567558697, 7.6710886414463557, 7.3672456093093359, 7.0789738298234948, 6.8065717681050781, 6.5497724500567163, 6.3079460092457946, 6.0802630942115075, 5.8658109584922267, 5.6636674697671019, 5.4729431639949935, 5.2928017941865066, 5.1224680931984174, 4.9612290172590265, 4.8084323020152953, 4.6634841739180235, 4.5258467122754116, 4.3950346589927136, 4.27061130285652, 4.1521832372335021, 4.0393941092775778, 3.9319177835239505, 3.829451529556962, 3.7317098728950522, 3.6384196352377876, 3.5493164842850233, 3.4641430762061662, 3.3826486603824457, 3.3045898623977314, 3.229732281350036, 3.1578525266259265, 3.0887403610041155, 3.0222006908497439, 2.9580552307916075, 2.8961437536630354, 2.836324904454631, 2.7784766008314508, 2.7224960573105976, 2.6682994552621531, 2.6158212430539711, 2.5650130044576245, 2.5158418001301106, 2.4682878894532969, 2.4223417940206238, 2.3780007688109253, 2.3352648800777933, 2.2941330100721515, 2.2545991744020935, 2.2166495201995398, 2.1802602735939485, 2.1453967537120788, 2.1120134129514194, 2.080054740111986, 2.0494567951677332, 2.0201491308603394, 1.9920568809971293, 1.9651028386312583, 1.9392093938674426, 1.9143002427256264, 1.8903018130097353, 1.8671443811323716, 1.8447628766199491, 1.8230973893742621, 1.8020934089459797, 1.7817018351019618, 1.761878804944871, 1.7425853840695056, 1.7237871681940318, 1.705453837950565, 1.6875587036600646, 1.6700782695657774, 1.6529918388032396, 1.6362811720106383, 1.6199302046028976, 1.6039248209499541, 1.5882526784744171, 1.5729030712696686, 1.5578668212455935, 1.5431361848299048, 1.5287047645205603, 1.5145674166681291, 1.500720149349037, 1.4871600067339379, 1.4738849387331618, 1.4608936567815201, 1.4481854783510049, 1.4357601641273083, 1.4236177527383969, 1.4117583984580295, 1.400182217401174, 1.388889147374111, 1.3778788257647578, 1.3671504887306631, 1.3567028935794094, 1.3465342647924301, 1.3366422627788548, 1.3270239733090239, 1.3176759147719832, 1.308594059977719, 1.2997738691713738, 1.2912103311784411, 1.2828980100600846, 1.2748310952125887, 1.2670034533921402, 1.2594086816073307, 1.2520401601510449, 1.2448911052307394, 1.2379546207200467, 1.2312237485313857, 1.2246915170443633, 1.2183509869593883, 1.2121952939135752, 1.2062176872144319, 1.2004115641221749, 1.1947704992373438, 1.1892882687117847, 1.1839588691811915, 1.1787765314972667, 1.1737357295021398, 1.1688311842252213, 1.1640578639869734, 1.1594109809621929, 1.1548859847893949, 1.1504785538162838, 1.1461845845497693, 1.1420001798384956, 1.137921636262863, 1.1339454311466219, 1.1300682095407231, 1.1262867714671372, 1.1225980596502469, 1.1189991479086288, 1.1154872303305887, 1.1120596113137569, 1.1087136965122113, 1.1054469847036341, 1.1022570605639042, 1.0991415883161766, 1.096098306206073, 1.093125021743161, 1.0902196076409201, 1.0873799983830257, 1.0846041873413357, 1.0818902243715398, 1.0792362138145399, 1.0766403128349811, 1.0741007300334733, 1.0716157242742799, 1.069183603676511, 1.066802724723146, 1.0644714914484654, 1.0621883546709183, 1.0599518112440509, 1.0577604033040173, 1.0556127174968024, 1.053507384173175, 1.0514430765431571, 1.0494185097852413, 1.0474324401085999, 1.0454836637689278, 1.0435710160405014, 1.0416933701486986, 1.0398496361684353, 1.0380387598949348, 1.0362597216938956, 1.034511535338517, 1.0327932468410799, 1.0311039332870877, 1.0294427016793848, 1.0278086878000976, 1.0262010550974729, 1.0246189936045667, 1.0230617188961417, 1.0215284710896626, 1.0200185138957416, 1.0185311337225682, 1.0170656388383383, 1.015621358594915, 1.0141976427150854, 1.0127938606451461], 'Rp': [0.72130873106978022, 0.77994665433697052, 0.79688333847802839, 0.80667409652733535, 0.81398198368537789, 0.82000696558939146, 0.82528395820090417, 0.83012587284211303, 0.83473852856452291, 0.83926397248620321, 0.84380022313556979, 0.84841133630088006, 0.85313336508351023, 0.85797867925206128, 0.86293947648158253, 0.86799061330474947, 0.87309210244366353, 0.8781922564823883, 0.88323254109012339, 0.88815422580417713, 0.89290547258851682, 0.89744678430789693, 0.90175336967196285, 0.90581439974019173, 0.90963024478720012, 0.9132090361320645, 0.91656351810166725, 0.91970862762220484, 0.9226598589139029, 0.92543228550751044, 0.92804005782996091, 0.93049620544293021, 0.93281260925026499, 0.93500005127704144, 0.93706828822892829, 0.93902612492965798, 0.94088148309855513, 0.94264147041799362, 0.94431245668497832, 0.94590016095599572, 0.94740974883451523, 0.94884593467430023, 0.95021308085947076, 0.95151528594205936, 0.95275645499823303, 0.95394034838109587, 0.95507060823751644, 0.95615076497470841, 0.9571842278328011, 0.95817426467992139, 0.95912397617915213, 0.96003626882166138, 0.96091383026000898, 0.96175910917384122, 0.96257430076780703, 0.96336133809535052, 0.96412188883198202, 0.96485735694740749, 0.96556888894453208, 0.96625738485092172, 0.96692351476750715, 0.96756774221717601, 0.96819035549048971, 0.96879150745584786, 0.96937126290597486, 0.96992965075898796, 0.97046671685659724, 0.97098257227591767, 0.97147743235358675, 0.97195164297926051, 0.97240569273477873, 0.97284021153099021, 0.97325595799412878, 0.97365379871144986, 0.97403468258685844, 0.97439961320119517, 0.9747496214810214, 0.97508574035655005, 0.97540898253766872, 0.9757203220846361, 0.9760206800854071, 0.97631091445632368, 0.97659181364670822, 0.97686409384578388, 0.97712839916342953, 0.97738530418179892, 0.97763531824989547, 0.97787889090987024, 0.97811641789640891, 0.97834824722934866, 0.97857468501772815, 0.97879600070180006, 0.97901243156972584, 0.97922418648872389, 0.97943144887880096, 0.97963437902482964, 0.97983311586652155, 0.9800277784257756, 0.98021846702962168, 0.98040526446981358, 0.9805882372120075, 0.98076743673495459, 0.98094290104629434, 0.98111465639047768, 0.98128271913722231, 0.98144709781619643, 0.98160779524618469, 0.98176481069457833, 0.98191814199633698, 0.98206778756008895, 0.98221374819421436, 0.98235602869554695, 0.98249463915870172, 0.98262959598140198, 0.98276092256039671, 0.98288864969043632, 0.98301281569326249, 0.9831334663144593, 0.9832506544311107, 0.98336443961406261, 0.98347488758500712, 0.9835820696026073, 0.98368606180459883, 0.9837869445255627, 0.98388480160396552, 0.98397971968792319, 0.98407178754670321, 0.98416109539386865, 0.98424773422886114, 0.98433179520419423, 0.98441336902651366, 0.98449254540024811, 0.98456941252223829, 0.9846440566347836, 0.98471656164287014, 0.9847870087993168, 0.98485547645900895, 0.98492203990124105, 0.9849867712169712, 0.98504973925578521, 0.98511100962646003, 0.98517064474363658, 0.98522870391295891, 0.98528524344697255, 0.98534031680430401, 0.98539397474519541, 0.98544626549721137, 0.98549723492563956, 0.98554692670418131, 0.98559538248187828, 0.98564264204374263, 0.98568874346240298, 0.98573372323953046, 0.98577761643582074, 0.98582045678905417, 0.98586227682009175, 0.98590310792696589, 0.9859429804675478, 0.98598192383139305, 0.98601996650163559, 0.98605713610769286, 0.98609345946994809, 0.98612896263713412, 0.98616367091760382, 0.9861976089053287, 0.98623080050150969, 0.98626326893270344, 0.98629503676614849, 0.98632612592302005, 0.98635655769017538, 0.98638635273088859, 0.98641553109509506, 0.98644411222932737, 0.98647211498682319, 0.98649955763783737, 0.9865264578804096, 0.98655283285170869, 0.98657869913993623, 0.98660407279683848, 0.98662896935085587, 0.98665340382083078, 0.98667739073019378, 0.98670094412164411, 0.98672407757210201, 0.98674680420800731, 0.98676913672071853, 0.98679108738194732, 0.98681266805923729, 0.98683389023118229, 0.98685476500246661, 0.98687530311859917, 0.98689551498007233, 0.98691541065618116, 0.98693499989811206, 0.98695429215148955, 0.98697329656809785, 0.98699202201693659, 0.98701047709433376, 0.98702867013336848, 0.98704660921233189]}
'''

# Plot the MSE values
plt.plot(nmf.all_performances['MSE'])