"""
Recover the toy dataset generated by example/generate_toy/bnmf/generate_bnmf.py
using VB.

We can plot the MSE, R2 and Rp as it converges, on the entire dataset.

We have I=100, J=80, K=10, and no test data.
We give flatter priors (1/10) than what was used to generate the data (1).
"""

project_location = "/home/tab43/Documents/Projects/libraries/"
import sys
sys.path.append(project_location)

from BNMTF.code.bnmf_vb_optimised import bnmf_vb_optimised
from ml_helpers.code.mask import calc_inverse_M

import numpy, matplotlib.pyplot as plt

##########

input_folder = project_location+"BNMTF/experiments/generate_toy/bnmf/"

iterations = 200
init_UV = 'random'
I, J, K = 100,80,10

alpha, beta = 1., 1. #1., 1.
lambdaU = numpy.ones((I,K))/10.
lambdaV = numpy.ones((J,K))/10.
priors = { 'alpha':alpha, 'beta':beta, 'lambdaU':lambdaU, 'lambdaV':lambdaV }

# Load in data
R = numpy.loadtxt(input_folder+"R.txt")
M = numpy.ones((I,J))
#M = numpy.loadtxt(input_folder+"M.txt")
M_test = calc_inverse_M(numpy.loadtxt(input_folder+"M.txt"))

# Run the VB algorithm
BNMF = bnmf_vb_optimised(R,M,K,priors) 
BNMF.initialise(init_UV)
BNMF.run(iterations)

# Also measure the performances
performances = BNMF.predict(M_test)
print "Performance on test set: %s." % performances

# Plot the tau expectation values to check convergence
plt.plot(BNMF.all_exp_tau)

# Extract the performances across all iterations
print "vb_all_performances = %s" % BNMF.all_performances

'''
vb_all_performances = {'R^2': [-560.4067225066677, -12.040601161232978, 0.6125568111794182, 0.6896401537920964, 0.6950793028184614, 0.7140342871871777, 0.7410966278984309, 0.7781626795018175, 0.8317152402073413, 0.8740801903589457, 0.8916897925909282, 0.904988983559727, 0.9186114441236645, 0.9297768535908805, 0.9392119051425584, 0.9455322274960668, 0.9488483961980763, 0.9510891702391907, 0.9533145191920473, 0.9560675762066344, 0.9592305757523639, 0.9620675754776621, 0.9642205111560448, 0.9658939285169069, 0.9673159266995018, 0.9685986668801774, 0.9697630709478591, 0.9707911424451949, 0.9716707002405175, 0.9724085949463058, 0.9730240585200274, 0.9735396143395467, 0.9739742219056378, 0.9743425958048924, 0.9746572300865158, 0.9749283681045833, 0.9751639933495717, 0.975370331381193, 0.9755523529325935, 0.9757141075398106, 0.9758589065125972, 0.9759894254783728, 0.9761077885799713, 0.9762156712093923, 0.9763144177145907, 0.9764051399103791, 0.976488777249096, 0.9765661290047637, 0.9766378754352022, 0.9767045968993483, 0.9767667919464558, 0.9768248923033684, 0.9768792739388815, 0.9769302652459878, 0.97697815367741, 0.9770231914176624, 0.9770656000116127, 0.9771055738858025, 0.9771432830066705, 0.9771788751824348, 0.9772124793863638, 0.9772442118330714, 0.9772741838426919, 0.9773025077587496, 0.9773292990347984, 0.9773546757632444, 0.9773787571218324, 0.9774016614146961, 0.9774235044107312, 0.977444398501196, 0.9774644524838504, 0.9774837713824996, 0.9775024559335984, 0.9775206017858611, 0.9775382986729755, 0.9775556297952209, 0.9775726715200446, 0.977589493396634, 0.9776061584133221, 0.9776227234045016, 0.9776392395203538, 0.9776557526947015, 0.9776723040732646, 0.9776889303881028, 0.9777056642783414, 0.9777225345601859, 0.9777395664421211, 0.9777567816670011, 0.9777741985436498, 0.9777918318058924, 0.9778096922045079, 0.9778277857148304, 0.9778461123289655, 0.9778646647965168, 0.9778834283602279, 0.9779023827246536, 0.9779215062564478, 0.9779407805156157, 0.9779601928179237, 0.9779797360755456, 0.9779994068447109, 0.9780192029710587, 0.9780391217466798, 0.9780591588737031, 0.9780793081530922, 0.9780995616777781, 0.9781199102981838, 0.9781403441738394, 0.9781608532929473, 0.9781814279085521, 0.9782020588860421, 0.9782227379744913, 0.9782434580094481, 0.978264213039165, 0.9782849983513299, 0.9783058103721504, 0.9783266464220302, 0.9783475043470142, 0.9783683820966493, 0.97838927736084, 0.9784101873720588, 0.9784311089079887, 0.9784520384307858, 0.978472972243756, 0.9784939065714328, 0.9785148375435133, 0.9785357611253496, 0.9785566730513858, 0.9785775687890964, 0.978598443518962, 0.9786192920863006, 0.978640108871247, 0.9786608875309081, 0.9786816205906295, 0.9787022988993043, 0.9787229110119886, 0.9787434426111645, 0.9787638761146943, 0.9787841906312404, 0.9788043623900651, 0.9788243656672124, 0.978844174067193, 0.9788637618754022, 0.9788831051673766, 0.978902182472727, 0.9789209749715775, 0.9789394663444119, 0.9789576424471536, 0.9789754909560127, 0.9789930010668642, 0.9790101632793312, 0.9790269692616818, 0.9790434117781205, 0.9790594846579054, 0.9790751827891755, 0.9790905021250187, 0.9791054396930254, 0.9791199936017715, 0.9791341630387125, 0.9791479482546906, 0.9791613505314684, 0.9791743721307908, 0.9791870162261969, 0.9791992868214591, 0.979211188661324, 0.9792227271406161, 0.979233908216747, 0.9792447383286335, 0.9792552243227515, 0.9792653733851899, 0.9792751929775999, 0.9792846907749191, 0.9792938746035061, 0.9793027523795113, 0.9793113320485853, 0.9793196215291512, 0.9793276286621637, 0.9793353611704398, 0.9793428266301231, 0.9793500324556599, 0.9793569858980201, 0.979363694054109, 0.9793701638838676, 0.9793764022308336, 0.9793824158420734, 0.9793882113843486, 0.9793937954547439, 0.9793991745853852, 0.9794043552429563, 0.9794093438243244, 0.9794141466497133, 0.979418769954682, 0.9794232198818075, 0.9794275024726006, 0.9794316236598997, 0.9794355892608024, 0.9794394049701097, 0.9794430763542528, 0.9794466088456971, 0.9794500077378512], 'MSE': [22075.771406156797, 512.78568405604187, 15.235135110399439, 12.204045202636996, 11.990165664440649, 11.244813168370229, 10.180661238393901, 8.7231409606322536, 6.6173341703770134, 4.9514493177620924, 4.2590002646213438, 3.7360462493876923, 3.2003805486705112, 2.7613316075501593, 2.390324220374326, 2.1417949707310475, 2.0113957801354214, 1.9232835194135989, 1.8357778077561986, 1.7275214316109733, 1.6031451957555614, 1.491588003965312, 1.406929744662814, 1.3411272210297815, 1.2852110633486409, 1.2347708426194548, 1.1889838632477674, 1.148557786297643, 1.1139716011850944, 1.0849559264634534, 1.0607545184332294, 1.0404817073632007, 1.0233919631621089, 1.0089066752844906, 0.99653454969495703, 0.98587279473832179, 0.97660748166430122, 0.96849380750284619, 0.96133631187869395, 0.95497575795288059, 0.94928193759958779, 0.94414963914800798, 0.9394953365380454, 0.93525314959885031, 0.93137021555384414, 0.92780281535110354, 0.92451400761775904, 0.92147236310669622, 0.91865113255481556, 0.91602749494713165, 0.91358184620888927, 0.91129720987234375, 0.90915880200127308, 0.90715370944671125, 0.90527062892292109, 0.90349964396923133, 0.90183204294456931, 0.90026018056128065, 0.89877737335781227, 0.89737780918353205, 0.89605641652027768, 0.89480862554879093, 0.89363005891173375, 0.89251629900977858, 0.8914628059502554, 0.89046493607489929, 0.88951800304751172, 0.88861735488423443, 0.8877584392924438, 0.88693683679580615, 0.88614826922239875, 0.88538860680066278, 0.8846538883472701, 0.88394035274026361, 0.88324447144979124, 0.88256297285427365, 0.8818928540144193, 0.88123138010018665, 0.88057607426907558, 0.87992470166528247, 0.87927525094897918, 0.87862591589922678, 0.87797507857404911, 0.87732129458646357, 0.87666328049287889, 0.87599990317546439, 0.87533017138005564, 0.87465323012887108, 0.87396835947789586, 0.87327498006007609, 0.87257266913066966, 0.87186119172613485, 0.87114054815691144, 0.87041102352483413, 0.86967319811832255, 0.86892786999980232, 0.86817588984095584, 0.86741798274373738, 0.86665464748066123, 0.86588616276094654, 0.86511266400137043, 0.86433423591623504, 0.86355098498660743, 0.86276308021441983, 0.8619707653596812, 0.86117435134607689, 0.86037419795550041, 0.85957069213729143, 0.85876422757778759, 0.85795518754913858, 0.85714393124476329, 0.85633078310956434, 0.85551602486585998, 0.85469989054970474, 0.85388256545977814, 0.85306419012561507, 0.85224486991494985, 0.8514246895261236, 0.85060372958755714, 0.84978208093738639, 0.84895985240099625, 0.84813717068711769, 0.84731417491171057, 0.8464910104370742, 0.84566782572302224, 0.84484477295853833, 0.84402201079503558, 0.84319970696372637, 0.84237803969369207, 0.8415571984992376, 0.84073738607401494, 0.83991882340373714, 0.83910175990517821, 0.83828648949851736, 0.83747337202580385, 0.83666285752789182, 0.83585550900169747, 0.83505201781631055, 0.8342532054659757, 0.83346000666941922, 0.83267343295026464, 0.83189452223836591, 0.83112428568964114, 0.83036366406765072, 0.82961350163625069, 0.82887453843516556, 0.82814741618437326, 0.82743269106069395, 0.8267308476631714, 0.82604231083424295, 0.82536745415002777, 0.82470660523292105, 0.82406004861061299, 0.82342802693052874, 0.82281074120250164, 0.82220835056018959, 0.82162097188540473, 0.82104867955319116, 0.82049150551461292, 0.81994943990599356, 0.81942243232556333, 0.81891039383642128, 0.81841319964791193, 0.81793069232270987, 0.81746268528674837, 0.81700896640341991, 0.81656930141394746, 0.81614343712567994, 0.81573110431982743, 0.81533202042326125, 0.81494589202711731, 0.81457241733564512, 0.8142112885988595, 0.81386219453598774, 0.8135248227062114, 0.81319886173939293, 0.81288400331159638, 0.81257994374433729, 0.81228638512666895, 0.81200303590592648, 0.81172961095770679, 0.81146583121578808, 0.81121142299967297, 0.81096611720611556, 0.81072964852532792, 0.81050175480529563, 0.81028217663385649, 0.81007065715316939, 0.80986694207871268, 0.80967077987133662, 0.80948192200566282, 0.80930012328552159, 0.80912514217101161, 0.80895674109638527, 0.80879468676912003, 0.80863875044789679, 0.80848870820037422, 0.8083443411419865, 0.80820543565601244, 0.80807178359375587], 'Rp': [0.021587326819517617, 0.68688777763711628, 0.82102204674967449, 0.8314233532042995, 0.8339687404149313, 0.84535578146293966, 0.86137940511244282, 0.88289465108340737, 0.91315948307977501, 0.93591595309514886, 0.94490221011790343, 0.95176155107281368, 0.95881861858582018, 0.9645597023258371, 0.96939121168314857, 0.97258126245804732, 0.97423396677048091, 0.97536624209334444, 0.97650289243667654, 0.97791629216195308, 0.97954057356636548, 0.98099203240573607, 0.98208703763249239, 0.98293502591698079, 0.98365451842050189, 0.98430223751235413, 0.98488786591170308, 0.98540224674829646, 0.98584014062724001, 0.98620598804682802, 0.98651026377772255, 0.98676479985014764, 0.98697919552619795, 0.98716073988404407, 0.98731566561888995, 0.98744910172128408, 0.98756503002557061, 0.98766654041397173, 0.98775609272222431, 0.98783568768020702, 0.98790695854531552, 0.98797122203993937, 0.98802952078774953, 0.98808267635379787, 0.98813134982793982, 0.98817609027721087, 0.98821736176803987, 0.98825555683405952, 0.98829100645004331, 0.98832399066892285, 0.98835474929081357, 0.9883834905312443, 0.98841039689494103, 0.9884356289217775, 0.98845932776320033, 0.988481617087975, 0.98850260452359484, 0.98852238311821727, 0.98854103356330902, 0.9885586273736563, 0.98857523033689798, 0.98859090524258653, 0.98860571321235635, 0.98861971382252611, 0.98863296513042354, 0.98864552430689523, 0.98865744832743474, 0.98866879401544527, 0.98867961756225575, 0.98868997402616576, 0.98869991699314297, 0.98870949826436128, 0.98871876744943321, 0.98872777149978652, 0.98873655429744878, 0.98874515639100169, 0.98875361490561708, 0.98876196360384694, 0.98877023305085276, 0.98877845083538518, 0.98878664180689546, 0.98879482830212784, 0.9888030303479205, 0.98881126583739654, 0.98881955068305427, 0.98882789895192513, 0.98883632298584079, 0.98884483350513053, 0.9888534396843236, 0.9888621491670293, 0.98887096794655105, 0.98887989998919323, 0.98888894649570958, 0.98889810493765462, 0.98890736848645289, 0.98891672669209807, 0.98892616762007324, 0.98893568048007474, 0.98894525737431249, 0.98895489356293875, 0.98896458662638265, 0.98897433526207712, 0.98898413825665799, 0.98899399384784636, 0.98900389946987433, 0.9890138517818472, 0.98902384686052858, 0.98903388045656182, 0.98904394824720199, 0.98905404605353153, 0.98906417001492719, 0.98907431672432922, 0.98908448332562215, 0.98909466756639575, 0.98910486779127837, 0.98911508285874128, 0.98912531197363118, 0.98913555445133039, 0.98914580946417252, 0.98915607584759691, 0.98916635203650594, 0.98917663614835316, 0.98918692615559711, 0.98919722004945343, 0.98920751592020151, 0.98921781194155467, 0.98922810629949098, 0.98923839711742756, 0.98924868240789088, 0.989258960047253, 0.98926922774586878, 0.98927948297751567, 0.98928972283862737, 0.9892999438250959, 0.98931014153864583, 0.98932031036153856, 0.98933044316035201, 0.98934053109341957, 0.98935056359829743, 0.98936052861772594, 0.98937041307281481, 0.98938020351356049, 0.98938988680685014, 0.98939945070531132, 0.98940888419481776, 0.98941817760698902, 0.98942732255537202, 0.98943631178028757, 0.98944513897474662, 0.98945379863422855, 0.98946228594623753, 0.9894705967181131, 0.98947872733481546, 0.98948667473701102, 0.98949443641169255, 0.98950201038965413, 0.98950939524598425, 0.98951659010012227, 0.9895235946129376, 0.98953040897768929, 0.98953703390293668, 0.9895434705862366, 0.98954972067889124, 0.9895557862437665, 0.98956166970897108, 0.9895673738205194, 0.98957290159681111, 0.9895782562863964, 0.98958344132960552, 0.98958846032361159, 0.98959331698981357, 0.98959801514260948, 0.98960255865888347, 0.98960695144794475, 0.98961119742267778, 0.98961530047265855, 0.98961926444087434, 0.98962309310530916, 0.98962679016667887, 0.98963035924294251, 0.98963380387021482, 0.98963712750923671, 0.98964033355527881, 0.98964342534960303, 0.98964640619019972, 0.98964927934035996, 0.98965204803413354, 0.98965471547858719, 0.98965728485322468, 0.98965975930734185, 0.98966214195598257, 0.98966443587538155, 0.98966664409811955, 0.98966876960856942, 0.98967081533859791, 0.98967278416362781, 0.98967467889903449, 0.98967650229688353, 0.98967825704296186, 0.98967994575410645]}
'''

plt.figure()
plt.plot(BNMF.all_performances['MSE'])