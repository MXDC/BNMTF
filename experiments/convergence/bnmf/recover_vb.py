"""
Recover the toy dataset generated by example/generate_toy/bnmf/generate_bnmf.py
using VB.

We can plot the MSE, R2 and Rp as it converges, on the entire dataset.

We have I=100, J=80, K=10, and no test data.
We give flatter priors (1/10) than what was used to generate the data (1).
"""

project_location = "/home/tab43/Documents/Projects/libraries/"
import sys
sys.path.append(project_location)

from BNMTF.code.bnmf_vb_optimised import bnmf_vb_optimised
from ml_helpers.code.mask import calc_inverse_M

import numpy, matplotlib.pyplot as plt

##########

input_folder = project_location+"BNMTF/experiments/generate_toy/bnmf/"

iterations = 1000
init_UV = 'random'
I, J, K = 100,80,10

alpha, beta = 1., 1. #1., 1.
lambdaU = numpy.ones((I,K))/10.
lambdaV = numpy.ones((J,K))/10.
priors = { 'alpha':alpha, 'beta':beta, 'lambdaU':lambdaU, 'lambdaV':lambdaV }

# Load in data
R = numpy.loadtxt(input_folder+"R.txt")
M = numpy.ones((I,J))
#M = numpy.loadtxt(input_folder+"M.txt")
M_test = calc_inverse_M(numpy.loadtxt(input_folder+"M.txt"))

# Run the VB algorithm
BNMF = bnmf_vb_optimised(R,M,K,priors) 
BNMF.initialise(init_UV)
BNMF.run(iterations)

# Also measure the performances
performances = BNMF.predict(M_test)
print "Performance on test set: %s." % performances

# Plot the tau expectation values to check convergence
plt.plot(BNMF.all_exp_tau)

# Extract the performances across all iterations
print "vb_all_performances = %s" % BNMF.all_performances

'''
vb_all_performances = {'R^2': [-688.5511174525433, -15.20864296747169, 0.5862945582589986, 0.6884036465459529, 0.6952399461921066, 0.7136280156223966, 0.73975874746943, 0.7714539025328889, 0.805807507154146, 0.8595039571939112, 0.9015223147668299, 0.91915929465708, 0.9291579528911349, 0.9368992797921408, 0.9424864420743768, 0.9466779147703466, 0.9502480009853017, 0.9534667318545337, 0.9562473693643262, 0.9584450853965566, 0.960135955213673, 0.9615249889909642, 0.9628007504160377, 0.9640787773532875, 0.9654127847307932, 0.9668059320674439, 0.9681968750743277, 0.9694851041443624, 0.9705913805014224, 0.9714921379780641, 0.9722178462927836, 0.972814841483407, 0.9733215724458553, 0.9737657020801425, 0.974164440639246, 0.9745280724828671, 0.9748631749077985, 0.9751740925376916, 0.9754638125054782, 0.9757345019402731, 0.9759878514485072, 0.976225269484529, 0.9764479628133159, 0.9766569542513406, 0.976853064238053, 0.9770369121914881, 0.9772089661827834, 0.9773696175153451, 0.977519239943313, 0.9776582098742396, 0.977786899603996, 0.9779056898924835, 0.9780150189529712, 0.978115424407641, 0.9782075413711868, 0.9782920547290463, 0.9783696435298597, 0.9784409481717153, 0.9785065581624411, 0.9785670098859202, 0.9786227882321968, 0.9786743296317223, 0.9787220256764306, 0.9787662270683377, 0.9788072477221452, 0.9788453688014459, 0.9788808424872076, 0.9789138953779806, 0.9789447315079094, 0.9789735349952896, 0.979000472336416, 0.9790256943743213, 0.9790493379959492, 0.9790715276222646, 0.9790923765432219, 0.9791119881208689, 0.9791304568562478, 0.9791478693041263, 0.9791643048278817, 0.9791798362068106, 0.9791945301268531, 0.9792084475945511, 0.9792216443118444, 0.9792341710398913, 0.9792460739683979, 0.9792573950964119, 0.9792681726225773, 0.9792784413373915, 0.9792882330065412, 0.9792975767328557, 0.9793064992851472, 0.9793150253853036, 0.9793231779498053, 0.9793309782869315, 0.9793384462548927, 0.9793456003881638, 0.9793524579994975, 0.9793590352641223, 0.9793653472912554, 0.9793714081868287, 0.9793772311104008, 0.9793828283285714, 0.9793882112666611, 0.9793933905598897, 0.979398376104721, 0.9794031771105176, 0.9794078021511964, 0.9794122592162526, 0.9794165557603609, 0.9794206987507346, 0.9794246947115288, 0.9794285497647468, 0.9794322696673273, 0.9794358598443111, 0.9794393254181807, 0.979442671234624, 0.9794459018850831, 0.9794490217264993, 0.9794520348986987, 0.9794549453398219, 0.9794577568001717, 0.9794604728547749, 0.9794630969148956, 0.9794656322386485, 0.9794680819408097, 0.9794704490018604, 0.9794727362762662, 0.9794749464999778, 0.9794770822971431, 0.9794791461860437, 0.9794811405843101, 0.9794830678135209, 0.9794849301033491, 0.9794867295954669, 0.9794884683474461, 0.9794901483368912, 0.9794917714659958, 0.9794933395666263, 0.9794948544059237, 0.9794963176922862, 0.9794977310814874, 0.9794990961826118, 0.9795004145634709, 0.979501687755211, 0.9795029172558991, 0.9795041045330032, 0.979505251024779, 0.9795063581406938, 0.9795074272610669, 0.9795084597361526, 0.9795094568848829, 0.979510419993466, 0.9795113503140062, 0.9795122490632575, 0.9795131174215995, 0.9795139565322791, 0.979514767500944, 0.979515551395477, 0.9795163092461247, 0.9795170420459083, 0.9795177507512938, 0.9795184362830954, 0.9795190995275771, 0.9795197413377071, 0.9795203625345204, 0.9795209639085344, 0.9795215462211689, 0.9795221102061189, 0.9795226565706414, 0.979523185996724, 0.9795236991421167, 0.9795241966412168, 0.9795246791058162, 0.9795251471257189, 0.9795256012692509, 0.9795260420836881, 0.9795264700956235, 0.9795268858113012, 0.9795272897169378, 0.9795276822790492, 0.9795280639447965, 0.9795284351423608, 0.9795287962813533, 0.9795291477532615, 0.9795294899319337, 0.9795298231740941, 0.9795301478198937, 0.9795304641934796, 0.979530772603588, 0.9795310733441492, 0.9795313666949012, 0.979531652922005, 0.9795319322786595, 0.9795322050057088, 0.9795324713322408, 0.9795327314761709, 0.979532985644813, 0.9795332340354296, 0.9795334768357655, 0.9795337142245595], 'MSE': [27114.696407222891, 637.360192903045, 16.267825794068571, 12.252667440692932, 11.983848806711064, 11.260788677450138, 10.23326969735129, 8.9869451169481724, 7.6360843377786551, 5.5246194961977855, 3.8723634410863434, 3.1788378370221326, 2.7856681710841511, 2.4812618357202059, 2.2615620843509494, 2.0967439776524213, 1.956360180982289, 1.8297924644970955, 1.720451561425105, 1.6340324381795905, 1.5675436448256961, 1.512923721490981, 1.4627579210834454, 1.4125030356562398, 1.3600468737698064, 1.3052651960555113, 1.250570197531347, 1.1999141413625247, 1.1564128739365691, 1.1209930698096371, 1.0924565913154625, 1.0689814015280428, 1.0490556036297187, 1.0315914303518354, 1.0159121359495737, 1.0016133163345642, 0.98843633744588033, 0.97621035893778807, 0.96481792004411193, 0.95417380438779609, 0.94421153353242782, 0.93487572389424523, 0.9261189227679153, 0.91790091071584234, 0.91018942621883236, 0.90296011237056828, 0.89619456356418403, 0.8898773928721585, 0.88399390344348361, 0.87852929408902869, 0.87346892530018005, 0.86879782474368195, 0.86449876089101263, 0.86055059323223138, 0.85692834763319781, 0.85360509286249964, 0.85055412720468793, 0.84775026877068926, 0.84517033679061704, 0.84279323944722584, 0.84059990977650212, 0.83857318635431721, 0.83669767090758862, 0.83495957304652713, 0.83334654894103766, 0.83184754260808935, 0.83045263772644784, 0.82915292393292905, 0.82794037814737109, 0.82680776042547244, 0.8257485237595138, 0.82475673666314719, 0.82382701643475242, 0.82295447056294535, 0.82213464423264648, 0.82136347301632273, 0.82063724092105139, 0.8199525444192487, 0.81930626276493135, 0.81869553411294105, 0.81811773622254591, 0.81757047017969842, 0.81705154565920246, 0.81655896661847804, 0.81609091677467926, 0.81564574463107031, 0.81522194813128857, 0.81481815923495649, 0.81443312884403318, 0.81406571257000271, 0.81371485780312602, 0.8133795924233348, 0.81305901530322233, 0.81275228855345905, 0.81245863130467644, 0.81217731473975308, 0.81190765808241816, 0.81164902528642191, 0.81140082222344845, 0.81116249421662379, 0.81093352380258832, 0.81071342863113915, 0.81050175943303415, 0.81029809800758978, 0.8101020552036492, 0.80991326888842363, 0.80973140191627002, 0.80955614012231769, 0.8093871903720391, 0.80922427869898517, 0.80906714855874284, 0.80891555922041092, 0.80876928430825135, 0.80862811049749361, 0.8084918363606356, 0.8083602713543574, 0.80823323493286936, 0.80811055577145929, 0.80799207108288063, 0.80787762601061774, 0.80776707308435258, 0.80766027172600585, 0.8075570877970305, 0.80745739318105225, 0.80736106539808161, 0.80726798724891646, 0.8071780464895657, 0.80709113553631684, 0.8070071512017859, 0.80692599446149382, 0.80684757024878473, 0.80677178727398269, 0.80669855786134625, 0.80662779779552163, 0.80655942616816967, 0.80649336521544379, 0.80642954013882961, 0.80636787890522732, 0.80630831202669706, 0.80625077232518694, 0.80619519469195866, 0.8061415158542119, 0.80608967416207078, 0.80603960940744546, 0.80599126268296151, 0.80594457628450278, 0.80589949365661551, 0.80585595937590293, 0.80581391916509393, 0.80577331992917023, 0.80573410980477533, 0.80569623821530456, 0.80565965592521871, 0.80562431508901533, 0.80559016929152094, 0.80555717357771073, 0.80552528447103466, 0.80549445997994296, 0.80546465959282942, 0.80543584426187242, 0.80540797637669115, 0.8053810197287965, 0.80535493946830572, 0.80532970205459142, 0.80530527520272566, 0.80528162782778234, 0.80525872998902814, 0.8052365528359372, 0.80521506855757086, 0.80519425033664505, 0.8051740723089682, 0.8051545095286019, 0.80513553793852188, 0.80511713434630949, 0.80509927640411516, 0.80508194259182075, 0.80506511220261023, 0.80504876532983116, 0.80503288285435159, 0.8050174464317259, 0.805002438478574, 0.80498784215785346, 0.80497364136273719, 0.8049598206990527, 0.80494636546625398, 0.80493326163713541, 0.80492049583621006, 0.80490805531727505, 0.80489592794013265, 0.80488410214678952, 0.80487256693731946, 0.80486131184567078, 0.80485032691549818, 0.80483960267626686, 0.804829130119739, 0.80481890067697137, 0.80480890619593826, 0.80479913891982546, 0.80478959146608231, 0.8047802568063076], 'Rp': [0.028548944611970516, 0.57461920394105237, 0.81917652007941411, 0.83098728901810559, 0.83409887940611194, 0.84513150818256833, 0.86060616700561288, 0.87899315996066729, 0.89852152099494265, 0.92831432008005832, 0.95050653431702758, 0.95925268401685881, 0.96429078570487581, 0.96820556873640551, 0.97101516679471023, 0.97313722262498015, 0.97495942374759559, 0.97660780742691322, 0.97802805115500679, 0.97914538759774006, 0.98000511279224489, 0.98070999417860483, 0.98135722564790473, 0.98200682554056207, 0.98268603472978999, 0.98339517691376566, 0.98410089958027036, 0.98475088625703255, 0.98530533180008961, 0.98575320030019098, 0.98611123808619572, 0.98640413480417621, 0.98665201643931066, 0.9868691164790977, 0.9870641961899187, 0.98724241685272818, 0.98740699865010162, 0.98756000075617034, 0.98770280044674141, 0.98783638448434308, 0.98796152572425722, 0.98807887706605924, 0.98818900851916847, 0.98829241174815219, 0.9883894856487816, 0.98848053292070959, 0.98856578256110894, 0.98864542576632142, 0.9887196439069188, 0.98878861625972192, 0.98885251471833446, 0.9889115132426578, 0.98896582210955819, 0.98901571326506743, 0.98906151077699644, 0.98910355791004712, 0.9891421885609325, 0.98917771410617961, 0.98921041997674286, 0.98924056590875764, 0.98926838733657607, 0.98929409710429894, 0.98931788724447534, 0.98933993075804483, 0.9893603833675515, 0.98937938519980739, 0.98939706236007041, 0.98941352839074193, 0.98942888562273634, 0.98944322641592375, 0.9894566342731671, 0.98946918481983592, 0.98948094665916431, 0.98949198212764156, 0.9895023479728654, 0.98951209596537848, 0.98952127344197993, 0.98952992377209914, 0.98953808674195309, 0.98954579886149896, 0.98955309360867627, 0.98956000163142177, 0.98956655092683921, 0.98957276701321617, 0.98957867310451608, 0.98958429029181838, 0.98958963773199116, 0.98959473284082111, 0.98959959148537024, 0.98960422816902316, 0.98960865620239891, 0.98961288785464541, 0.989616934481931, 0.98962080663298868, 0.98962451413378372, 0.9896280661547453, 0.98963147126453155, 0.98963473747355823, 0.9896378722701985, 0.98964088265168126, 0.98964377515155399, 0.9896465558649773, 0.98964923047279418, 0.98965180426558419, 0.98965428216767293, 0.98965666876168101, 0.98965896831327171, 0.98966118479591303, 0.98966332191517348, 0.9896653831321478, 0.98966737168557661, 0.98966929061237585, 0.9896711427662459, 0.9896729308344947, 0.98967465735283333, 0.98967632471847244, 0.98967793520154046, 0.98967949095512731, 0.98968099402408694, 0.98968244635287728, 0.98968384979265067, 0.98968520610759547, 0.98968651698084853, 0.98968778401990065, 0.98968900876164334, 0.98969019267691494, 0.98969133717471469, 0.9896924436059964, 0.98969351326689681, 0.98969454740164386, 0.9896955472048945, 0.98969651382377377, 0.98969744835959161, 0.98969835186935717, 0.98969922536731092, 0.98970006982650982, 0.9897008861807961, 0.9897016753269503, 0.98970243812732184, 0.98970317541281905, 0.98970388798597342, 0.98970457662417788, 0.98970524208274657, 0.98970588509762614, 0.98970650638772162, 0.98970710665661021, 0.9897076865937815, 0.98970824687528403, 0.98970878816399421, 0.9897093111094708, 0.98970981634764332, 0.98971030450028452, 0.98971077617445757, 0.98971123196203636, 0.98971167243912794, 0.98971209816573391, 0.98971250968546265, 0.98971290752530028, 0.98971329219557125, 0.98971366419001283, 0.98971402398587671, 0.98971437204421631, 0.98971470881021528, 0.98971503471357425, 0.98971535016899914, 0.98971565557670305, 0.98971595132286849, 0.98971623778020579, 0.98971651530841376, 0.98971678425464171, 0.98971704495388124, 0.98971729772934547, 0.98971754289274894, 0.98971778074458805, 0.98971801157436601, 0.98971823566077843, 0.98971845327187957, 0.98971866466526981, 0.98971887008822967, 0.98971906977792112, 0.98971926396150167, 0.98971945285643192, 0.98971963667057328, 0.98971981560250899, 0.98971998984176668, 0.98972015956908543, 0.98972032495671014, 0.98972048616869235, 0.98972064336121246, 0.9897207966828675, 0.98972094627504881, 0.98972109227216365, 0.98972123480206242, 0.98972137398626658, 0.98972150994035824, 0.98972164277420938, 0.98972177259231087, 0.98972189949405109, 0.98972202357399996, 0.9897221449221697]}
'''