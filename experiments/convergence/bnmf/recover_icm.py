"""
Recover the toy dataset generated by example/generate_toy/bnmf/generate_bnmf.py
using ICM.

We can plot the MSE, R2 and Rp as it converges, on the entire dataset.

We have I=100, J=80, K=10, and no test data.
We give flatter priors (1/10) than what was used to generate the data (1).
"""

project_location = "/home/tab43/Documents/Projects/libraries/"
import sys
sys.path.append(project_location)

from BNMTF.code.nmf_icm import nmf_icm
from ml_helpers.code.mask import calc_inverse_M

import numpy, matplotlib.pyplot as plt

##########

input_folder = project_location+"BNMTF/experiments/generate_toy/bnmf/"

iterations = 200
init_UV = 'random'
I, J, K = 100,80,10

alpha, beta = 1., 1. #1., 1.
lambdaU = numpy.ones((I,K))/10.
lambdaV = numpy.ones((J,K))/10.
priors = { 'alpha':alpha, 'beta':beta, 'lambdaU':lambdaU, 'lambdaV':lambdaV }

# Load in data
R = numpy.loadtxt(input_folder+"R.txt")
M = numpy.ones((I,J))
#M = numpy.loadtxt(input_folder+"M.txt")
M_test = calc_inverse_M(numpy.loadtxt(input_folder+"M.txt"))

# Run the VB algorithm
NMF = nmf_icm(R,M,K,priors) 
NMF.initialise(init_UV)
NMF.run(iterations)

# Also measure the performances
performances = NMF.predict(M_test)
print "Performance on test set: %s." % performances

# Plot the tau values to check convergence
plt.plot(NMF.all_tau)

# Extract the performances across all iterations
print "icm_all_performances = %s" % NMF.all_performances

'''
icm_all_performances = {'R^2': [0.668754465598049, 0.7582982561613575, 0.8513609875083048, 0.8878447822881418, 0.9029202022840023, 0.9122528139639328, 0.9199104282227271, 0.9272246576262166, 0.934317158006694, 0.9406433298793984, 0.9459152134779856, 0.9501748072670242, 0.9536522110358676, 0.956611930587333, 0.9592000863013393, 0.9614748093887133, 0.9634733044051218, 0.9652117211361498, 0.9667090066335086, 0.9679901977335392, 0.9690921594159685, 0.970051706915515, 0.9708939900305701, 0.9716373749822591, 0.972296526079011, 0.9728844146839037, 0.9734114090791048, 0.9738866022020929, 0.9743163065511125, 0.9747061733589458, 0.9750611129923865, 0.9753844908214173, 0.9756792149372933, 0.9759501426568366, 0.9762016553895667, 0.9764354792217186, 0.9766533981280122, 0.9768565352481724, 0.9770455676660958, 0.9772212893285199, 0.977384654519638, 0.977536692887111, 0.9776779818035294, 0.9778087988781835, 0.9779290222544942, 0.9780388182961572, 0.9781393645272938, 0.9782310172624553, 0.9783144515904219, 0.9783903488288203, 0.978459460829851, 0.9785227379120809, 0.9785807228303697, 0.9786344692472514, 0.978684294965471, 0.9787305575762508, 0.978773806154363, 0.9788142400734311, 0.9788519550610622, 0.9788871850543023, 0.9789200930733724, 0.9789507403718443, 0.978979273533006, 0.9790058745091126, 0.9790306673295068, 0.9790537050873229, 0.9790750986484327, 0.9790949891187717, 0.9791136025954396, 0.9791310611864037, 0.9791474286121864, 0.9791628072464234, 0.9791771407120956, 0.9791905077153926, 0.979203031241259, 0.9792147766835163, 0.9792258148364548, 0.9792360318757273, 0.9792456806098291, 0.9792547625860949, 0.9792632637347903, 0.9792712699531659, 0.9792788710149387, 0.9792860728314818, 0.9792929083433597, 0.9792994255018891, 0.97930560500967, 0.9793114863527632, 0.9793170963605481, 0.9793224551192016, 0.9793275855410752, 0.9793325024310203, 0.979337201669899, 0.9793416963430821, 0.9793459994341438, 0.9793501278645138, 0.9793540960775295, 0.9793579062070626, 0.9793615746524235, 0.9793651127984656, 0.9793685289219853, 0.9793718310949431, 0.9793750267551605, 0.9793781215838645, 0.9793811187720206, 0.9793840336798362, 0.9793868678879014, 0.9793896260353528, 0.9793923134678254, 0.9793949341975238, 0.9793974917598413, 0.9793999892912816, 0.9794024299970815, 0.9794048187667295, 0.979407158078574, 0.9794094477181198, 0.9794116915138219, 0.9794138934488438, 0.9794160540709927, 0.9794181744620165, 0.9794202563711658, 0.9794223012880283, 0.979424310514232, 0.9794262841514502, 0.9794282109653057, 0.9794300913594367, 0.9794319292914961, 0.9794337284108429, 0.9794354900759604, 0.9794371990753725, 0.9794388556924942, 0.9794404679873153, 0.9794420376873841, 0.9794435688336787, 0.9794450641605247, 0.9794465257763082, 0.9794479556129881, 0.9794493560889223, 0.9794507290270184, 0.9794520760844652, 0.9794533985392629, 0.9794546979615033, 0.979455975309806, 0.979457231385452, 0.9794584673846232, 0.9794596844627581, 0.9794608843967466, 0.9794620688233662, 0.9794632370388466, 0.9794643906366455, 0.9794655291351823, 0.9794666521768534, 0.9794677606291798, 0.9794688555102747, 0.979469937162691, 0.9794710061150684, 0.9794720631496839, 0.9794731086010595, 0.9794741442088385, 0.9794751695134826, 0.979476184892493, 0.97947719045824, 0.979478185627541, 0.9794791708238989, 0.9794801465824835, 0.9794811131843177, 0.9794820709739183, 0.9794830201091407, 0.9794839608849426, 0.9794848935406648, 0.9794858182819413, 0.979486735040965, 0.9794876422769151, 0.9794885395533031, 0.9794894280645616, 0.9794903084067776, 0.9794911809562802, 0.9794920467055649, 0.9794929035615302, 0.9794937519423417, 0.9794945928014189, 0.9794954261689747, 0.9794962515958283, 0.9794970707088774, 0.9794978831246637, 0.9794986889356929, 0.9794994883055093, 0.979500281401555, 0.9795010683852254, 0.9795018514169846, 0.9795026275013246, 0.9795033984609586, 0.9795041629384049, 0.979504921547195, 0.9795056750521182, 0.9795064235891222, 0.9795071666351988, 0.9795079044848245, 0.9795086372286295, 0.9795093649036758], 'MSE': [13.025317303144458, 9.5042546366871594, 5.8448193266238935, 4.4101946930023139, 3.8173953688430493, 3.4504161471681098, 3.149301580639809, 2.8616896767376305, 2.5827966552960495, 2.3340373894391639, 2.1267351029922898, 1.9592383221378604, 1.8224990071094684, 1.7061161965283134, 1.6043441093491029, 1.5148968959901987, 1.4363115898834447, 1.3679531452402054, 1.3090765214943034, 1.2586972140902255, 1.2153656093473486, 1.1776340496703346, 1.1445135885825148, 1.1152820250789843, 1.0893627256643981, 1.0662456272514134, 1.0455230257320725, 1.0268373664118153, 1.0099404277025108, 0.99460999045703258, 0.98065296804049484, 0.96793702655758795, 0.95634781333814434, 0.94569432779111873, 0.93580428306793129, 0.92660980558670447, 0.91804074546049452, 0.91005293831643586, 0.90261975969720409, 0.89570998983647721, 0.88928610413959563, 0.88330761455131079, 0.87775181748648545, 0.87260779672522371, 0.86788034394150648, 0.86356291734170865, 0.85960921403653867, 0.85600522293870696, 0.85272439804336086, 0.84973994841340039, 0.84702230953411228, 0.84453411274815782, 0.84225401571719793, 0.84014058606733122, 0.83818132708188064, 0.83636217747201047, 0.83466154638625467, 0.83307159400660136, 0.83158855610885363, 0.83020323376369454, 0.82890921665043926, 0.82770409614126661, 0.82658210825254075, 0.82553609821352947, 0.82456118891231445, 0.82365529260777881, 0.822814049805209, 0.82203191190275726, 0.82129998825538753, 0.82061347730397505, 0.81996987341467376, 0.81936515102652907, 0.81880152701037023, 0.81827590646230464, 0.81778345333849933, 0.81732159620721945, 0.81688755127821233, 0.81648579438007329, 0.8161063845157992, 0.81574926084071175, 0.8154149766083244, 0.81510015414610004, 0.81480126335015279, 0.8145180717720315, 0.81424928411486586, 0.81399301482533837, 0.81375002272049801, 0.81351875511987837, 0.81329815703210806, 0.8130874386236655, 0.81288569892950069, 0.81269235578966093, 0.81250757117788264, 0.81233083054803834, 0.81216162335686859, 0.81199928421581236, 0.81184324518044859, 0.81169342234216191, 0.8115491708432846, 0.81141004300584274, 0.81127571336764226, 0.81114586452110193, 0.81102020399438257, 0.81089850838891464, 0.81078065222876849, 0.81066603151614325, 0.81055458409868364, 0.81044612755514922, 0.81034045168317093, 0.81023739871387535, 0.81013682962765976, 0.81003862109016578, 0.80994264706429486, 0.80984871528440106, 0.80975672829625356, 0.80966669453429818, 0.80957846345509066, 0.80949187843170833, 0.8094069179231429, 0.80932353939265, 0.80924167405576364, 0.80916126333855698, 0.80908225605810358, 0.80900464821636731, 0.8089288815742649, 0.80885494025984184, 0.80878266864930115, 0.80871192324167229, 0.80864265061832885, 0.80857544892863997, 0.8085103070280899, 0.80844690797980023, 0.80838518385270208, 0.80832497574647, 0.80826617614128582, 0.80820870213068574, 0.80815247774570964, 0.80809740789110751, 0.80804342088605519, 0.80799045156617699, 0.80793844967763428, 0.80788735348090346, 0.80783712528090901, 0.80778773356948264, 0.80773913131007591, 0.80769127306824895, 0.80764408897270501, 0.80759751466168761, 0.80755157780901876, 0.80750621575637216, 0.80746144744057624, 0.80741728692339976, 0.80737370009197817, 0.80733064691181455, 0.80728811391296629, 0.80724608030812794, 0.80720451533641424, 0.80716340584367352, 0.80712268342322724, 0.80708236614515294, 0.80704243916525464, 0.80700289806488212, 0.80696376577608264, 0.80692502564577195, 0.80688665662987258, 0.80684864767793329, 0.80681098524278927, 0.80677366311720189, 0.80673666970277225, 0.80669999558809347, 0.80666363268716978, 0.80662758366632414, 0.80659190911409084, 0.80655662619417712, 0.80652168793880796, 0.8064870709085179, 0.80645276030519386, 0.80641871710168755, 0.80638502360344677, 0.80635166336725839, 0.80631859890253088, 0.80628582902122803, 0.80625337138614273, 0.80622116202401528, 0.80618921601327997, 0.80615752971640176, 0.80612609670246071, 0.80609491038725289, 0.8060639644243458, 0.80603317385945517, 0.80600265648267022, 0.80597234062081469, 0.80594227965311627, 0.80591244945414575, 0.80588281995067002, 0.80585338579691324, 0.80582416755873765, 0.8057951536566661, 0.80576634052691576, 0.80573772671212562], 'Rp': [0.81786724568744607, 0.87088565182835664, 0.92312265398331872, 0.94267361808874506, 0.9505402062054138, 0.95538003540563543, 0.95934470419540163, 0.96313548633956536, 0.96680446179821788, 0.97005890342111933, 0.97275249848415768, 0.97492323484624466, 0.97669315779223398, 0.97820205799466975, 0.97952088966619988, 0.98067806097763266, 0.98169186329565905, 0.98256969166758112, 0.98332222639601807, 0.98396425415862554, 0.98451534166925159, 0.98499503677871536, 0.98541544131812597, 0.98578612479663963, 0.98611465508732177, 0.98640756691829268, 0.98667008231200781, 0.98690683307338911, 0.98712086880801797, 0.9873149145268445, 0.98749156732889642, 0.98765243532367941, 0.98779905771894161, 0.98793370159316651, 0.9880586250542468, 0.98817470711643574, 0.98828288940633791, 0.98838372901933169, 0.98847756941988341, 0.98856476234779644, 0.98864585633131163, 0.98872139283965677, 0.98879159977484787, 0.98885660027243982, 0.98891633007771773, 0.98897087790572968, 0.98902084055956141, 0.98906639554864584, 0.9891079146851095, 0.98914570731319107, 0.9891801158949709, 0.98921166783530101, 0.98924056321564047, 0.98926730964134779, 0.98929210265093148, 0.98931512527601362, 0.9893366735322574, 0.98935684257437106, 0.98937566433567148, 0.98939325484235818, 0.98940969686815694, 0.98942498926648681, 0.98943923304940351, 0.98945251168583426, 0.98946489148902783, 0.98947640009197935, 0.98948709083101749, 0.98949704389659776, 0.98950634763817102, 0.98951508418508349, 0.98952328393234101, 0.98953097715820626, 0.98953814820236086, 0.98954484683711308, 0.98955110209934183, 0.98955696435475227, 0.98956247213336368, 0.98956754585023932, 0.98957235222776896, 0.98957688032941205, 0.98958111590566555, 0.98958511038520169, 0.98958890758575069, 0.98959251015297289, 0.98959591445125183, 0.98959918396382029, 0.98960227680670687, 0.98960521858868522, 0.98960802393799419, 0.98961070333846846, 0.98961326879383482, 0.98961572775259377, 0.98961808470945101, 0.98962034107330077, 0.98962249952750903, 0.98962457087945555, 0.98962656113754588, 0.98962847276390353, 0.98963031292627357, 0.9896320872067661, 0.98963379981510335, 0.98963545532846042, 0.98963705783205469, 0.98963861146114818, 0.98964011473771607, 0.9896415760591708, 0.9896429967295084, 0.9896443796536627, 0.98964572702746789, 0.98964704072597964, 0.98964832248231116, 0.98964957383439367, 0.98965079636375042, 0.9896519925341497, 0.98965316531071257, 0.98965431201188714, 0.98965543604150841, 0.98965653959298128, 0.98965762267256552, 0.98965868573354565, 0.98965972951904901, 0.98966075468174308, 0.98966176179110454, 0.9896627503400941, 0.98966371438184275, 0.98966465657475977, 0.98966557821492906, 0.9896664809004394, 0.98966736543850298, 0.98966822498872942, 0.98966905783225168, 0.98966986771373955, 0.98967065584185321, 0.98967142429920807, 0.98967217434125598, 0.98967290703646782, 0.98967362342691945, 0.98967432485992868, 0.9896750122718746, 0.98967568650738091, 0.98967634827264617, 0.98967699832100597, 0.98967763715127555, 0.98967826518523039, 0.98967888303792473, 0.98967949146419287, 0.9896800918164208, 0.98968068547170718, 0.98968127211578583, 0.98968185017552912, 0.9896824204275434, 0.98968298272997623, 0.98968353746958027, 0.98968408536419694, 0.98968462669222002, 0.9896851616893334, 0.98968569079899515, 0.98968621411577784, 0.98968673332598156, 0.9896872469922362, 0.98968775583806889, 0.98968826046988689, 0.98968875914583276, 0.98968925271348684, 0.98968974129511955, 0.98969022504041626, 0.98969070419465655, 0.98969117892854286, 0.98969164942948695, 0.98969211583171679, 0.98969257823754708, 0.98969303667178432, 0.98969349048700705, 0.9896939393015165, 0.98969438366508522, 0.9896948238761647, 0.98969526012659359, 0.98969569365724053, 0.98969612349173552, 0.98969654895978987, 0.98969697026550607, 0.98969738758494064, 0.9896978008468329, 0.98969821070724862, 0.98969861716591523, 0.98969902025843925, 0.98969942006430334, 0.98969981667179785, 0.98970021016584475, 0.98970060285197492, 0.98970099195635186, 0.98970137912795086, 0.98970176191045334, 0.98970214125691758, 0.98970251820186617, 0.98970289285058455, 0.98970326449682466, 0.98970363339670897, 0.98970399963798295, 0.9897043632871465]}
'''