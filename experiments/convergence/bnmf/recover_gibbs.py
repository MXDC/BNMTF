"""
Recover the toy dataset generated by example/generate_toy/bnmf/generate_bnmf.py
using VB.

We can plot the MSE, R2 and Rp as it converges.

We have I=100, J=80, K=10, and 10% test data.
We give flatter priors (1/10) than what was used to generate the data (1).
"""

project_location = "/home/tab43/Documents/Projects/libraries/"
import sys
sys.path.append(project_location)

from BNMTF.code.bnmf_gibbs_optimised import bnmf_gibbs_optimised
from ml_helpers.code.mask import calc_inverse_M

import numpy, matplotlib.pyplot as plt

##########

input_folder = project_location+"BNMTF/experiments/generate_toy/bnmf/"

iterations = 200
burn_in = 180
thinning = 2

init_UV = 'random'
I, J, K = 100, 80, 10

alpha, beta = 1., 1.
lambdaU = numpy.ones((I,K))/10
lambdaV = numpy.ones((J,K))/10
priors = { 'alpha':alpha, 'beta':beta, 'lambdaU':lambdaU, 'lambdaV':lambdaV }

# Load in data
R = numpy.loadtxt(input_folder+"R.txt")
M = numpy.ones((I,J))

M_test = calc_inverse_M(numpy.loadtxt(input_folder+"M.txt"))

# Run the Gibbs sampler
BNMF = bnmf_gibbs_optimised(R,M,K,priors)
BNMF.initialise(init_UV)
BNMF.run(iterations)

taus = BNMF.all_tau
Us = BNMF.all_U
Vs = BNMF.all_V

# Plot tau against iterations to see that it converges
f, axarr = plt.subplots(3, sharex=True)
x = range(1,len(taus)+1)
axarr[0].set_title('Convergence of values')
axarr[0].plot(x, taus)
axarr[0].set_ylabel("tau")
axarr[1].plot(x, Us[:,0,0])    
axarr[1].set_ylabel("U[0,0]")
axarr[2].plot(x, Vs[:,0,0]) 
axarr[2].set_ylabel("V[0,0]")
axarr[2].set_xlabel("Iterations")

# Approximate the expectations
(exp_U, exp_V, exp_tau) = BNMF.approx_expectation(burn_in,thinning)

# Also measure the performances
performances = BNMF.predict(M_test,burn_in,thinning)
print performances

# Extract the performances across all iterations
print "gibbs_all_performances = %s" % BNMF.all_performances

'''
gibbs_all_performances = {'R^2': [0.5874084878121256, 0.6968575094174961, 0.7438150501278078, 0.8081103649542194, 0.8588449597144766, 0.8846677603553285, 0.9014806302366201, 0.9143249929550229, 0.9240016742523642, 0.9316092583881211, 0.9368493082653059, 0.9423049007709001, 0.9470821306681992, 0.951006618301034, 0.9545801753260581, 0.9570420167437889, 0.959813595486564, 0.9617482162402421, 0.9638261428596557, 0.965156140364875, 0.9665798513942868, 0.9683231488858309, 0.9691834804363861, 0.9693256894861841, 0.9701097222512446, 0.9707695915035803, 0.9706317053661928, 0.9708937783680278, 0.9712771298873855, 0.9715887504577357, 0.9720486620879139, 0.9717835059703902, 0.9719902288224801, 0.9717587542492996, 0.9718502531429035, 0.9717937436145887, 0.9722996105699292, 0.9726734319534867, 0.9729412502494873, 0.9730288621470177, 0.9728678952626644, 0.972782719067991, 0.9727218629086913, 0.9727862306820765, 0.9728219826333189, 0.9725745610346578, 0.9733314299291049, 0.9732612319477381, 0.973316959388951, 0.9730614134520519, 0.9730523075210362, 0.972861114632972, 0.9730989978412297, 0.9736434793589386, 0.9739515964775993, 0.9737273606044639, 0.9736705897545364, 0.974110772234789, 0.9740215476598245, 0.9740369877881883, 0.9740929186756776, 0.9742603518322159, 0.9743155846252362, 0.9739297415393755, 0.9739616743257331, 0.9740771634017203, 0.973831642717771, 0.9737776638251673, 0.9738758110852178, 0.973874812328321, 0.9737645771199395, 0.9738047741552153, 0.9741565600679803, 0.9740198205069471, 0.974395266737997, 0.974285982460653, 0.9742700271413154, 0.9741955232538795, 0.97417248184823, 0.9741876101410045, 0.9741205809646545, 0.9743646603926195, 0.9741958780257791, 0.973838418991211, 0.9742293679263851, 0.9742185217640112, 0.974449884321389, 0.9742595327903472, 0.9743112209015388, 0.9743073433889272, 0.9741704999526878, 0.9742284910630489, 0.9743197199103137, 0.9742366466054992, 0.9740449953161897, 0.9740627243579155, 0.9740229913149574, 0.9743163364244402, 0.9742121908428981, 0.9742379614450866, 0.9743361114844777, 0.974393856251815, 0.9743233886583487, 0.974547400215783, 0.9745674128464484, 0.9744922171716852, 0.9745986819555789, 0.9741904841710205, 0.974327158568242, 0.9740360566649877, 0.9742108739173541, 0.9743716808412197, 0.9743181494764056, 0.9743371825590994, 0.9744180187655346, 0.9741971862659029, 0.9743132100528112, 0.9742157306590223, 0.9745152112804452, 0.9742524632987778, 0.9742892598382283, 0.9744594970454822, 0.9744111776773939, 0.9743796440634348, 0.9742770407273198, 0.9740312691206398, 0.9741460034431412, 0.9743146818423831, 0.9744092940292278, 0.9739909729343131, 0.9744881024097435, 0.974248166787449, 0.9743639527656875, 0.9744541164437891, 0.9745765261193966, 0.9742760843042031, 0.9740571491334008, 0.9744735729985444, 0.9745401231632039, 0.9743461245232651, 0.974100088245077, 0.9738736732533884, 0.9744268434052776, 0.9746623821623084, 0.9743333390910394, 0.9746318892952087, 0.9743183589462627, 0.9745609045208568, 0.9746073799004449, 0.9744957345001413, 0.9744857208638376, 0.9745482293019533, 0.9741958141558219, 0.9739747125581331, 0.9738843527297539, 0.9741445070520781, 0.9739288204367405, 0.9742707845082201, 0.9746398291526907, 0.974633484506776, 0.9746053747067431, 0.9744575984511934, 0.9741839582690497, 0.9739913199769975, 0.9744956607981314, 0.9745505393997153, 0.9748921861628295, 0.9743191384506201, 0.9744289327155766, 0.9745218450795281, 0.9743260140233551, 0.9740611369850729, 0.9743894393879862, 0.9741267286381011, 0.9744594644773773, 0.9745928478946054, 0.9746919305424708, 0.9743701431335766, 0.9744258614773732, 0.9741299108427287, 0.9742149604526138, 0.9743957636503576, 0.9747784804257431, 0.9745511567790089, 0.9745535575156005, 0.9745215404314803, 0.9744038550542495, 0.9744024772369615, 0.9745301345042953, 0.9745620634205137, 0.9747431247606514, 0.9745286969391298, 0.9741591164687059, 0.9739259008283162, 0.9740279795289692, 0.9741677755548058, 0.9743748297569736, 0.9742453325667317, 0.974408933174864, 0.9742098113928572], 'MSE': [16.224023585809295, 11.920242592949917, 10.073766779679207, 7.5455308044181733, 5.5505327550349355, 4.5351223205661295, 3.8740025703008594, 3.3689334219244653, 2.9884246112416695, 2.6892773413546744, 2.4832268282274184, 2.2687006955496773, 2.0808493020064143, 1.9265296467626749, 1.786009370056578, 1.6892042442943216, 1.58021955225772, 1.5041459254135103, 1.4224371905338726, 1.3701387058187549, 1.3141551951593384, 1.245604828066436, 1.2117746620171952, 1.2061826832442846, 1.1753527565573874, 1.149405217654623, 1.1548272098164771, 1.144521911628378, 1.1294476701377245, 1.1171940504343618, 1.0991092936834748, 1.1095358268950097, 1.1014070207296887, 1.1105091200794335, 1.1069111783766763, 1.1091332597649719, 1.0892414365638476, 1.0745419413862711, 1.0640107253464988, 1.0605656290467909, 1.066895207942955, 1.0702445269437375, 1.0726375276106239, 1.0701064424023308, 1.0687005954979192, 1.0784297676542494, 1.0486679852807801, 1.0514283273424332, 1.0492369993729802, 1.0592856387294327, 1.0596437043590099, 1.0671618375095056, 1.0578077362557627, 1.0363975018607183, 1.0242816457350434, 1.0330991031646524, 1.0353314603048311, 1.0180224979759429, 1.0215310083691465, 1.0209238678940211, 1.0187245399607114, 1.0121406927402012, 1.0099688154470439, 1.0251410309204765, 1.023885362144648, 1.0193440726673531, 1.0289984965940016, 1.0311210677106335, 1.0272616973287809, 1.0273009706898952, 1.0316356663099853, 1.0300550287323118, 1.0162220176856422, 1.0215989238938026, 1.0068355360687433, 1.0111328389477712, 1.0117602378874162, 1.0146898978326333, 1.0155959375781587, 1.0150010591777645, 1.0176367967194124, 1.0080390462104019, 1.0146759474058871, 1.0287320383250662, 1.0133590494056415, 1.0137855448350725, 1.0046878501979115, 1.0121728993033594, 1.0101404068494277, 1.0102928793414805, 1.0156738701557122, 1.0133935296385819, 1.0098062067635134, 1.0130728354188492, 1.0206089939343754, 1.0199118482524696, 1.0214742406116069, 1.009939253016269, 1.0140344908517149, 1.0130211329774619, 1.0091616533056991, 1.0068909995487438, 1.0096619433628085, 1.0008533065296457, 1.0000663650091846, 1.0030232275836013, 0.99883679351037302, 1.0148880458718934, 1.0095137020509564, 1.0209604817465139, 1.0140862753176014, 1.0077629864265525, 1.0098679597468192, 1.0091195362494569, 1.0059408753195767, 1.0146245044702051, 1.0100621889602885, 1.0138952973428978, 1.0021190476578505, 1.0124508875667464, 1.0110039651112739, 1.0043098563279325, 1.0062098822479, 1.0074498546697908, 1.0114844479562253, 1.021148738727391, 1.0166371278498569, 1.0100043148935127, 1.0062839515182835, 1.0227332751467522, 1.0031850292514011, 1.0126198360280616, 1.0080668716883741, 1.0045214336536801, 0.99970801067835979, 1.0115220566581609, 1.0201310785840458, 1.0037563582851252, 1.001139456557437, 1.0087679181641516, 1.0184426164126028, 1.0273457616708683, 1.0055938706936951, 0.99633195852013823, 1.0092706700333944, 0.99753100644141379, 1.009859722922255, 1.0003222869677935, 0.99849477081120053, 1.0028849183403303, 1.0032786769775617, 1.0008207050020264, 1.0146784589158486, 1.0233726696055965, 1.0269258207091174, 1.0166959693024413, 1.0251772507418615, 1.0117304565221577, 0.99721879343836051, 0.9974682791449786, 0.99857361952463741, 1.0043845133133833, 1.0151446589731472, 1.0227196286500857, 1.0028878164686512, 1.0007298667771238, 0.98729554983398515, 1.0098290710627156, 1.0055117143270054, 1.0018581918001626, 1.0095587081228039, 1.0199742673126708, 1.0070646805402752, 1.0173950564119925, 1.0043111369788571, 0.99906620187200346, 0.99517004994345726, 1.0078234525397263, 1.0056324823010865, 1.017269924989247, 1.01392558358624, 1.0068159963602921, 0.99176671442617204, 1.0007055900386908, 1.000611187691735, 1.0018701712446429, 1.0064978242125195, 1.0065520030783419, 1.0015322330274743, 1.000276716434199, 0.99315697847037987, 1.0015887613138337, 1.0161214942758294, 1.0252920562929611, 1.0212780928495047, 1.0157809995904872, 1.0076391639969784, 1.0127312839430229, 1.0062981411211664, 1.0141280561637556], 'Rp': [0.77838009620439386, 0.83494597789348102, 0.86244815122590146, 0.89913516112319103, 0.92690711750513521, 0.94075204343184382, 0.94959113304969789, 0.95641694789644827, 0.96135645035414841, 0.96537354085512339, 0.96809630802456981, 0.9708528857568961, 0.97323056138232911, 0.97526559421662595, 0.97713822276811713, 0.97835268440914103, 0.97975528647900523, 0.98075390479123259, 0.98178897616930572, 0.98248426271096057, 0.98320443063582608, 0.98408813562575448, 0.98450730927707142, 0.98456080898276022, 0.98495980424187135, 0.98528816339898684, 0.98522301328269946, 0.98537891826703405, 0.98553958827326349, 0.9857314741755987, 0.98593445222541709, 0.98580089805334692, 0.98591280293627448, 0.98580197586747309, 0.98582818701912966, 0.98580041738556301, 0.98606078323375668, 0.98624477658958121, 0.9863965982452827, 0.98643621635063827, 0.98635804029273955, 0.98629790499050474, 0.98627336957843781, 0.98631970553614479, 0.98632710179778793, 0.98619374062981058, 0.98657700350618716, 0.98654213802277135, 0.98657323941803865, 0.98643908600165742, 0.98643856399262997, 0.98635012199784045, 0.98645834712965463, 0.98673888939052035, 0.98689114697048264, 0.98677637407193031, 0.9867520063930848, 0.98697118313913013, 0.98693004406202944, 0.98694637654102202, 0.98696400058454115, 0.98704782022493698, 0.98707449111598711, 0.98687921535259759, 0.98689588041261223, 0.9869583079682146, 0.9868367254987277, 0.98680311748556748, 0.98685985738401005, 0.98685764905467477, 0.98680150484622497, 0.98681930778221216, 0.98700356661744715, 0.98692920469225087, 0.98711489720219014, 0.98706084220089907, 0.98705475046567126, 0.98701400637786862, 0.98701510622682875, 0.98701318578432429, 0.98697669908027152, 0.98710522265525413, 0.98701458680518295, 0.98683355576568343, 0.98703124651438667, 0.98703130798583516, 0.98714275217032577, 0.98704623307285078, 0.98708149567209591, 0.98707524733234442, 0.98701871287269738, 0.98703017510134983, 0.98707852188227352, 0.98704307518848355, 0.98694919576461615, 0.98695130328294534, 0.98693762512002314, 0.98707841616136205, 0.98702222329449985, 0.98703915100005657, 0.98708615716339065, 0.98711399663116306, 0.98708436301879943, 0.98719893331615238, 0.98721302528779087, 0.98716485480256699, 0.98721991743738613, 0.98701665183460729, 0.98708188256511775, 0.98693406260073169, 0.98702154112165286, 0.98710347311714919, 0.98707705875895735, 0.98708817838399221, 0.98712902146840309, 0.98702575164705797, 0.98708352522359999, 0.98702735011709841, 0.98717718830748435, 0.98704691793860699, 0.98706233984200598, 0.98714922629700264, 0.98712291939443553, 0.98710685606395021, 0.98706159240993807, 0.98693649954276164, 0.98699048733095818, 0.98708380007620344, 0.9871219220072196, 0.98691458877206972, 0.98716227638892073, 0.98704068885519958, 0.98710081507146874, 0.98714604562520913, 0.98720960351953357, 0.98705752180367889, 0.98694755963302738, 0.9871619868595406, 0.98719152617688066, 0.98709163854805204, 0.98697068052325243, 0.9868532968593966, 0.98713082098719729, 0.98725987547598804, 0.98709036140294804, 0.98723544314341216, 0.98707615923098868, 0.98720322703393781, 0.98722461508406523, 0.98717229351093383, 0.98716338210671428, 0.98719438477807631, 0.9870333555506009, 0.98691067981527736, 0.98685822170530157, 0.98698759397335756, 0.98688475629180372, 0.98705349461083192, 0.98723883878257324, 0.98723583153047501, 0.98722179620570405, 0.9871483901761281, 0.98700827541188185, 0.98691215351334671, 0.98716652840510422, 0.98719479935864041, 0.98736730519012095, 0.987078953011297, 0.98713189586774486, 0.98718702402675196, 0.98708091742846138, 0.98694934769309728, 0.98711174685256764, 0.9869820293712368, 0.98714860661992621, 0.98721598448670578, 0.98727136724028641, 0.9871044558199612, 0.98713816245121888, 0.98698503458188758, 0.98702634260056188, 0.98712182024743311, 0.98730900599687021, 0.98719397234882345, 0.98719904031454253, 0.98717881478069913, 0.98712023819650963, 0.98712374703814532, 0.98719004860957527, 0.98720159955906828, 0.98729303084172304, 0.98719034408089645, 0.98699897660363245, 0.98687945841392766, 0.98692972153694847, 0.98699981402050241, 0.98710436731199747, 0.98703991426882631, 0.98712708229825141, 0.98702090733367798]}
'''